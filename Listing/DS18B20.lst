C51 COMPILER V9.54   DS18B20                                                               12/29/2019 00:50:56 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN ..\Output\DS18B20.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE DS18B20\DS18B20.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\GSM;.\Ultrason
                    -ic;.\XY-V17B;.\DS18B20;.\uart;.\delay;.\LED;.\BH1750;.\DHT11) DEBUG OBJECTEXTEND PRINT(..\Listing\DS18B20.lst) OBJECT(..
                    -\Output\DS18B20.obj)

line level    source

   1          #include "ds18b20.h"
   2          #include "delay.h"
   3          #include "stdio.h"
   4          #include "intrins.h"
   5          
   6          
   7          sbit DS18B20_DQ = P0^7;  //DS18B20 IOÉèÖÃ
   8           
   9          unsigned char flag_temper = 0;  //¶¨Òå±äÁ¿
  10           
  11          
  12          
  13          
  14          //****************************************************
  15          //DS18B20³õÊ¼»¯
  16          //****************************************************
  17          bit DS18B20_Init()
  18          {
  19   1              bit Flag_exist = 1;             //³õÊ¼»¯½á¹û±êÖ¾
  20   1              
  21   1              DS18B20_DQ = 1;                         //µ¥Æ¬»ú¹Ü½ÅµçÆ½À­¸ß£¬ÒÔÊÍ·Å×ÜÏß£¨Í¼ÖÐ²½Öè1£©
  22   1              delay2us();                                     //ÑÓÊ±>1us£¬Ö´ÐÐ2us
  23   1       
  24   1              DS18B20_DQ = 0;         //µ¥Æ¬»úµçÆ½À­µÍÒÔÆô¶¯DS18B20³õÊ¼»¯£¨Í¼ÖÐ²½Öè2£©
  25   1              delay500us();                   //ÑÓÊ±480~960usÖ´ÐÐ500us        
  26   1       
  27   1              DS18B20_DQ = 1;                         //ÊÍ·Å×ÜÏß£¨Í¼ÖÐ²½Öè3£©
  28   1              delay60us();                                    //ÑÓÊ±15~60us£¬Ö´ÐÐ60us±£ÏÕÆð¼û¼Ó¸öNOP
  29   1              _nop_();
  30   1              
  31   1              Flag_exist = DS18B20_DQ; //½«DS18B20Êä³ö×´Ì¬¶Áµ½³õÊ¼»¯½á¹û×´Ì¬±êÖ¾ÖÐ£¨Í¼ÖÐ²½Öè4£©
  32   1              
  33   1              delay500us();                                   //´Óµ¥Æ¬»úÊä³öµçÆ½À­¸ßÊ±£¨²½Öè3£©ËãÆð£¬×ÜÊ±³¤²»µÃÐ¡ÓÚ480us£¨Ö´ÐÐ500uS¼ÓÉÏÖ®Ç°µÄ60us¼°Ö¸
             -ÁîÖ´ÐÐÖÜÆÚ×ÜÖ´Ê±Ê±ÑÓ´óÓÚ560us£©
  34   1       
  35   1              return Flag_exist;              //·µ»Ø³õÊ¼»¯½á¹û±êÖ¾£¬ºóÃæ´úÂëÖÐÓÃÓÚÅÐ¶Ï³õÊ¼»¯ÊÇ·ñ³É¹¦  
  36   1      }
  37           
  38          //****************************************************
  39          //DS18B20Ð´1×Ö½Ú
  40          //****************************************************
  41          void DS18B20_Write_Byte( unsigned char dat)
  42          {
  43   1              unsigned char i;
  44   1              for( i = 0 ; i < 8 ; i++ )
  45   1              {
  46   2                      DS18B20_DQ = 0; //µ¥Æ¬»úÀ­µÍÆô¶¯DS18B20¶Á/Ð´Ê±Ðò£¨Ç°Ãæ±ØÐëÓÐ³õÊ¼»¯²Ù×÷£©£¨²½Öè2£©
  47   2                      delay2us();                     //ÑÓÊ±>1us£¨Ö´ÐÐ2us£©
  48   2                      
  49   2                      DS18B20_DQ = dat&0x01;  //DS18B20ÏÈÐ´Ö¸ÁîÊ±ÒªÇóÏÈµÍÎ»£¬¸ÃÖ¸ÁîÎªÈ¡³öÐ´Êý¾ÝµÄ×îµÍbitËÍ¸øµ¥Æ¬»ú×ÜÏß¹Ü½ÅÊä³ö 
             -£¨²½Öè3£©
  50   2                      dat >>= 1;                      //½«Ð´µÄÊý¾Ý½øÐÐÓÒÒÆÒ»Î»£¬½«Ô­ÏÈµÄµÚ¶þÎ»·ÅÖÃµ½Ä©Î»£¬ÎªÏÂ¸öÑ­»·¹ý³ÌÈ¡Öµ×ö×¼±¸
  51   2       
C51 COMPILER V9.54   DS18B20                                                               12/29/2019 00:50:56 PAGE 2   

  52   2                      delay60us();    //µ¥Æ¬»ú×ÜÏßÊä³ö±£³ÖÊ±¼äÐèÒª±£Ö¤´Ó×ÜÏßÀ­µÍ¿ªÊ¼£¨²½Öè2£©ÖÁÐ´Ò»¸ö×Ö½ÚÖ¸Áî½áÊø×ÜÊ±³¤´óÓÚ60us,Ö
             -´ÐÐ£¨2us+60us+Ö¸ÁîÊ±³¤´óÓÚ62us£©(²½Öè4)
  53   2                      _nop_();      //±£ÏÕÆð¼û¼Ó¸ö»úÆ÷ÖÜÆÚ£¬¿ÉÓÐ¿ÉÎÞ
  54   2                      
  55   2                      DS18B20_DQ = 1;         //Ö¸ÁîÐ´ÍêºóÒªÊÍ·Å×ÜÏß  £¨²½Öè5£©
  56   2                      delay2us();                     //Ð´ÏÂÒ»¸öBITÇ°±ØÐë¼ä¸ô1usÒÔÉÏ£¨Ö´ÐÐ2us) 
  57   2              }               
  58   1      }
  59           
  60          //****************************************************
  61          //DS18B20¶Á1×Ö½Ú
  62          //****************************************************
  63          unsigned char DS18B20_Read_Byte( )
  64          {
  65   1              unsigned char dat,i;
  66   1              for( i = 0 ; i < 8 ; i++ )
  67   1              {
  68   2                      DS18B20_DQ = 0; //µ¥Æ¬»úÀ­µÍ²¢±£³Ö1usÒÔÉÏ£¨Ö´ÐÐ2us£©Æô¶¯DS18B20¶Á/Ð´Ê±Ðò£¨Ç°Ãæ±ØÐëÓÐ³õÊ¼»¯²Ù×÷£©£¨²½Öè2£
             -©
  69   2                      delay2us();                     //ÑÓÊ±2us
  70   2                                      
  71   2                      DS18B20_DQ = 1;         //µ¥Æ¬»úÊä³ö¸ßµçÆ½£¬À­¸ß×ÜÏß¼´ÊÍ·Å×ÜÏß £¨²½Öè3£©
  72   2                      delay10us();                    //´Ó²½Öè2¿ªÊ¼£¬ÖÁÊÍ·ÅÊý¾ÝÏß£¨¼´´Ë´¦£©²»µÃ³¬¹ý15us£¬²¢ÇÒÔÚ¿ìµ½15usÊ±µ¥Æ¬»ú½øÐÐ×ÜÏßÊý¾Ý¶ÁÈ¡
             -£¬´Ë´¦ÑÓÊ±±ØÐë¾«È·£¨µ½´Ë´¦×ÜÑÓÊ±2+10+Á½ÌõÖ¸ÁîÂÔ´óÓÚ12us£©
  73   2       
  74   2                      dat >>= 1;        //½«Ç°ÃæÈ¡µ½µÄbit×óÒÆ£¬µÚÒ»´ÎÎª¿Õ×ª 
  75   2                      if( DS18B20_DQ == 1) //×ÜÏßÈ¡Öµ²Ù×÷ £¨²½Öè4£©
  76   2                      {
  77   3                              dat |= 0X80;  
  78   3                      }
  79   2                      else
  80   2                      {
  81   3                              dat &= 0x7f;
  82   3                      }
  83   2       
  84   2                      delay60us();    //¶ÁÊ±Ï¶×ÜÊ±³¤²»µÃÐ¡ÓÚ60us£¨Ö´ÐÐ12us+60us+Ö¸ÁîÖÜÆÚ´óÓÚ72us£¬Âú×ã´óÓÚ60usÒªÇó£©£¨²½Öè5£©                 
  85   2              }
  86   1              return dat;             
  87   1      }
  88           
  89          //**********************************************************
  90          //¶ÁÈ¡ÎÂ¶Èº¯Êý£¬·µ»ØÎÂ¶ÈµÄ¾ø¶ÔÖµ£¬²¢±ê×¢flag_temper£¬flag_temper=1±íÊ¾¸º£¬flag_temper=0±íÊ¾Õý
  91          //**********************************************************
  92          unsigned int Get_temp(void)         //¶ÁÈ¡ÎÂ¶ÈÖµ 
  93          {  
  94   1              float tt;
  95   1              unsigned int a=0,b=0;
  96   1              unsigned int temp=0;
  97   1              if( DS18B20_Init() == 0 )              //³õÊ¼»¯
  98   1              {
  99   2                      DS18B20_Write_Byte(0xcc);          //ºöÂÔROMÖ¸Áî
 100   2                      DS18B20_Write_Byte(0x44);          //ÎÂ¶È×ª»»Ö¸Áî
 101   2              
 102   2                      if( DS18B20_Init() == 0 )              //³õÊ¼»¯
 103   2                      {
 104   3                              DS18B20_Write_Byte(0xcc);          //ºöÂÔROMÖ¸Áî
 105   3                              DS18B20_Write_Byte(0xbe);          //¶ÁÔÝ´æÆ÷Ö¸Áî
 106   3                              a = DS18B20_Read_Byte();           //¶ÁÈ¡µ½µÄµÚÒ»¸ö×Ö½ÚÎªÎÂ¶ÈLSB
 107   3                              b = DS18B20_Read_Byte();           //¶ÁÈ¡µ½µÄµÚÒ»¸ö×Ö½ÚÎªÎÂ¶ÈMSB
 108   3                              temp = b;                      //ÏÈ°Ñ¸ß°ËÎ»ÓÐÐ§Êý¾Ý¸³ÓÚtemp
 109   3                              temp <<= 8;                    //°ÑÒÔÉÏ8Î»Êý¾Ý´ÓtempµÍ°ËÎ»ÒÆµ½¸ß°ËÎ»
 110   3                              temp = temp|a;                //Á½×Ö½ÚºÏ³ÉÒ»¸öÕûÐÍ±äÁ¿
C51 COMPILER V9.54   DS18B20                                                               12/29/2019 00:50:56 PAGE 3   

 111   3                              
 112   3      //                      if(temp>0xfff)
 113   3      //                      {
 114   3      //                              flag_temper=1;                          //ÎÂ¶ÈÎª¸ºÊý
 115   3      //                              temp=(~temp)+1;
 116   3      //                      }
 117   3      //                      else
 118   3      //                      {                                                                                                                                                          
 119   3      //                              flag_temper=0;                          //ÎÂ¶ÈÎªÕý»òÕß0
 120   3      //                      }
 121   3                              
 122   3                              tt = temp*0.0625;              //µÃµ½ÕæÊµÊ®½øÖÆÎÂ¶ÈÖµ
 123   3                                                              //ÒòÎªDS18B20¿ÉÒÔ¾«È·µ½0.0625¶È
 124   3                                                              //ËùÒÔ¶Á»ØÊý¾ÝµÄ×îµÍÎ»´ú±íµÄÊÇ0.0625¶È
 125   3                              temp = (unsigned int)(tt*10);               //·Å´óÊ®±¶
 126   3                                                              //ÕâÑù×öµÄÄ¿µÄ½«Ð¡ÊýµãºóµÚÒ»Î»Ò²×ª»»Îª¿ÉÏÔÊ¾Êý×Ö
 127   3                                                          //Í¬Ê±½øÐÐÒ»¸öËÄÉáÎåÈë²Ù×÷¡£
 128   3                      }
 129   2              }
 130   1              return temp;   //×¢Òâ·µ»ØÖµÊÇÊµ¼ÊÖµµÄÊ®±¶£¨Èç37.5¶È£¬·µ»ØÖµÎª375£©£¬Ä¿µÄÊÇÎªÔÚINTÐÍÖÐÈ¡Ð¡Êý¾Ýµãºó1Î»£¬
 131   1      }
 132          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    311    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      1      14
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
